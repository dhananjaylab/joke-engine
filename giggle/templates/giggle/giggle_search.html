{% extends "./base.html" %}

{% block content %} 

    <main>
        <form class="input-group query-input" action="/" method="post">
            {% csrf_token %}
            <input type="text" name="query" value="{{ topic|default:'' }}" class="form-control" placeholder="Input topic (e.g. Traffic)" maxlength="100" required/>

            <!-- Style selector for comedian persona -->
            <select name="style" class="form-select" style="max-width: 160px; margin-left:8px;">
                <option value="witty" {% if style == 'witty' %}selected{% endif %}>Witty</option>
                <option value="dad" {% if style == 'dad' %}selected{% endif %}>Dad Joke</option>
                <option value="sarcastic" {% if style == 'sarcastic' %}selected{% endif %}>Sarcastic</option>
                <option value="roast" {% if style == 'roast' %}selected{% endif %}>Roast Mode ðŸ”¥</option>
                <option value="haiku" {% if style == 'haiku' %}selected{% endif %}>Haiku</option>
            </select>

            <button class="btn btn-outline-secondary" type="submit" style="margin-left:8px;">
                <span class="material-icons mt-2"> search </span>
            </button>
        </form>
        <div class="results">
            {% if query %}
                <div class="joke joke-card p-3 bg-white border rounded shadow-sm">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3>{{ query }}</h3>
                        <div class="btn-group">
                            <button onclick="speakJoke()" class="btn btn-sm btn-info text-white" title="Listen">
                                <span class="material-icons">volume_up</span>
                            </button>
                            <button onclick="copyToClipboard()" class="btn btn-sm btn-secondary" title="Copy">
                                <span class="material-icons">content_copy</span>
                            </button>
                            <!-- Regenerate form: posts with regenerate flag to bypass cache -->
                            <form action="/" method="post" style="display:inline;">
                                {% csrf_token %}
                                <input type="hidden" name="query" value="{{ topic|default:query }}" />
                                <input type="hidden" name="style" value="{{ style|default:'witty' }}" />
                                <input type="hidden" name="regenerate" value="1" />
                                <button class="btn btn-sm btn-warning" title="Regenerate">Regenerate</button>
                            </form>
                        </div>
                    </div>
                    <p id="jokeText" class="lead mt-3">{{ response }}</p>
                    {% if joke_id %}
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-info" onclick="generateMeme({{ joke_id }})">Generate Meme</button>
                        </div>
                        <div id="meme-result" class="mt-2"></div>
                    {% endif %}
                </div>
            {% endif %}
            <!-- Quick heckle form: submit your own joke for rating/roast -->
            <div class="mt-4 p-3 bg-white border rounded shadow-sm">
                <h5>Reverse Heckler â€” Tell the AI your joke</h5>
                <form action="/" method="post">
                    {% csrf_token %}
                    <div class="mb-2">
                        <textarea name="heckle_joke" class="form-control" rows="2" placeholder="Type your joke here..."></textarea>
                    </div>
                    <button class="btn btn-sm btn-danger" type="submit">Rate & Roast</button>
                </form>
                {% if heckle_result %}
                    <div class="mt-3">
                        <h6>Your joke</h6>
                        <p>{{ heckle_input }}</p>
                        <h6>AI's Rating & Roast</h6>
                        <p>{{ heckle_result }}</p>
                    </div>
                {% endif %}
            </div>
            <a href="{% url 'giggle_history' %}" class="history-link">
                <small>See history</small>
            </a>
        </div>
    </main>

    <script>
        function speakJoke() {
            let text = document.getElementById("jokeText").innerText;
            if (!text) return;
            let utterance = new SpeechSynthesisUtterance(text);
            utterance.pitch = 1.05;
            utterance.rate = 1.02;
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
        }

        function copyToClipboard() {
            let text = document.getElementById("jokeText").innerText;
            if (!text) return;
            navigator.clipboard.writeText(text).then(function() {
                // small UX feedback
                alert('Joke copied!');
            }, function(err) {
                console.error('Could not copy text: ', err);
            });
        }
    </script>
    <script>
        async function generateMeme(id) {
            const target = document.getElementById('meme-result');
            if (!target) return;
            target.innerText = 'Generating image...';
            try {
                const res = await fetch(`/meme/${id}/`);
                if (!res.ok) throw new Error('Image generation failed');
                const data = await res.json();
                if (data.image_url) {
                    target.innerHTML = `<img src="${data.image_url}" alt="meme" style="max-width: 100%; height: auto; border-radius:8px;"/>`;
                } else {
                    target.innerText = 'No image generated.';
                }
            } catch (e) {
                target.innerText = 'Error generating image.';
            }
        }
    </script>

{% endblock %}
{% extends "./base.html" %}

{% block content %} 

    <main>
        <form class="input-group query-input" action="/" method="post">
            {% csrf_token %}
            <input type="text" name="query" value="{{ topic|default:'' }}" class="form-control" placeholder="Input topic (e.g. Traffic)" maxlength="100" required/>

            <!-- Style selector for comedian persona -->
            <select name="style" class="form-select" style="max-width: 160px; margin-left:8px;">
                <option value="witty" {% if style == 'witty' %}selected{% endif %}>Witty</option>
                <option value="dad" {% if style == 'dad' %}selected{% endif %}>Dad Joke</option>
                <option value="sarcastic" {% if style == 'sarcastic' %}selected{% endif %}>Sarcastic</option>
                <option value="roast" {% if style == 'roast' %}selected{% endif %}>Roast Mode ðŸ”¥</option>
                <option value="haiku" {% if style == 'haiku' %}selected{% endif %}>Haiku</option>
            </select>

            <button class="btn btn-outline-secondary" type="submit" style="margin-left:8px;">
                <span class="material-icons mt-2"> search </span>
            </button>
        </form>
        <div class="results">
            {% if query %}
                <div class="joke joke-card p-3 bg-white border rounded shadow-sm">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3>{{ query }}</h3>
                        <div class="btn-group">
                            <button onclick="speakJoke()" class="btn btn-sm btn-info text-white" title="Listen">
                                <span class="material-icons">volume_up</span>
                            </button>
                            <button onclick="copyToClipboard()" class="btn btn-sm btn-secondary" title="Copy">
                                <span class="material-icons">content_copy</span>
                            </button>
                            <!-- Regenerate form: posts with regenerate flag to bypass cache -->
                            <form action="/" method="post" style="display:inline;">
                                {% csrf_token %}
                                <input type="hidden" name="query" value="{{ topic|default:query }}" />
                                <input type="hidden" name="style" value="{{ style|default:'witty' }}" />
                                <input type="hidden" name="regenerate" value="1" />
                                <button class="btn btn-sm btn-warning" title="Regenerate">Regenerate</button>
                            </form>
                        </div>
                    </div>
                    <p id="jokeText" class="lead mt-3">{{ response }}</p>
                </div>
            {% endif %}
            <a href="{% url 'giggle_history' %}" class="history-link">
                <small>See history</small>
            </a>
        </div>
    </main>

    <script>
        function speakJoke() {
            let text = document.getElementById("jokeText").innerText;
            if (!text) return;
            let utterance = new SpeechSynthesisUtterance(text);
            utterance.pitch = 1.05;
            utterance.rate = 1.02;
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
        }

        function copyToClipboard() {
            let text = document.getElementById("jokeText").innerText;
            if (!text) return;
            navigator.clipboard.writeText(text).then(function() {
                // small UX feedback
                alert('Joke copied!');
            }, function(err) {
                console.error('Could not copy text: ', err);
            });
        }
    </script>

{% endblock %}